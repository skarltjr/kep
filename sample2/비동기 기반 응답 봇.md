# agit-event-bot
- 비동기 기반 아지트 글/댓글 생성 이벤트 응답 봇

### 1. 기존 문제점
```
1. 아지트 글/ 댓글 생성 이벤트 발생 ( 애플리케이션에게 post request )
2. 애플리케이션 내부에서 글 / 댓글 중 어떤 이벤트인지 파싱
3. ex) 글 생성 이벤트를 전달받은경우 "글 생성 이벤트 응답 댓글입니다~"를 작성하도록 agit에 post request 
4. 3번 요청 응답이 200이면 정상반환 / 그 외 4xx 5xx면 애플리케이션 또한 정상응답 반환 실패 


문제점 : 
애플리케이션이 agit에 강하게 결합되어있다.
-> 응답속도 영향
-> agit 장애가 그대로 애플리케이션에 전달
```

### 2. 해결 방향
- <img width="915" alt="스크린샷 2022-06-17 오후 5 02 51" src="https://user-images.githubusercontent.com/62214428/174508790-04661dec-be2b-4af7-9337-9dc246108ef0.png">

```
원인 : 애플리케이션과 외부 시스템의 강한 결합
해결 방법 : 
- 외부 시스템 호출을 별도의 task로 다루고 이를 비동기로 수행

호출 시점과 응답 시점이 다른 비동기 방식을 활용한다면 외부 서비스로 인한 응답 시간 지연을 해결할 수 있으며
celery 라이브러리를 활용하여 외부 서비스 호출 작업을 별도의 task로 다룸으로써 외부 서비스 장애 발생 시
task의 상태에 따라 로그를 기록하는 등 요청에 대한 응답 과정에 영향을 주지 않으면서 별도의 처리가 가능

(기존에는 애플리케이션에서 아지트 요청이 불가능하면 애플리케이션이 영향을 받았지만 이를 하나의 task로 다룸으로써 아지트의 장애로 인한 댓글 생성 실패를 한 task의 장애로 축소 
-> celery는 task의 상태를 SUCCESS,FAILURE, PENDING등의 상태에 따른 유연한 처리가 가능)
```
### 3. workflow!
- ![Untitled Diagram drawio](https://user-images.githubusercontent.com/62214428/174508822-6e1ce636-1d11-468b-9a37-32648bdd8022.png)


### 4. 개선
```
1. 응답속도 약 1초에서 -> 2xx ms
2. agit로부터 응답 댓글 생성 요청에 대한 응답이 200이 아닌 다른 응답이 와도 애플리케이션에 영향 x 동시에 task 상태에 따른 유연한 처리 가능
- 기존에는 아지트 호출이 불가능한경우 애플리케이션은 5xx 서버 에러를 발생
- 개선 후 : 응답으로 에러 원인 및 별도의 상태코드 반환 가능
```

### 5. celery 라이브러리 선택 및 활용 이유
```
0. 비동기 작업
1. 비교적 많은 참고 내용
2. 작업을 하나의 task로 다룬다. 
- 작은 단위의 task로 분리함으로써 아지트 댓글 생성 요청의 실패를 task 실패라는 작은 범위의 장애로 축소할 수 있다고 생각.
3. task 상태 & 상태에 따른 유연한 처리가 가능하다고 판단 ( SUCCESS,FAILURE,PENDING.. 등 task 상태 존재) 
```

### 6. 메세지 브로커 redis 선택 이유
```
1.redis
만약 은행처럼 하나하나의 작업의 손실이 매우 큰 문제를 발생하며, 작업(메세지) 자체가 굉장히 크다면 좀 더 안정적인 rabbitMQ나 kafka를 활용했을 것
그러나 이 경우는 작업자체가 무겁지 않으며 특히 여기서는 문의에 대한 빠른 응답이 좀 더 중요하다고 생각하여 메세지 브로커로 redis를 활용
redis의 경우 Key-Value를 이용하는 캐쉬서버로 메세지 접근에서 key를 활용하기 때문에 작업 조회에 시간복잡도 O(1)로 빠른 대응 가능할것이라고 생각

2. 메세지 브로커의 필요성
- 동시 다발적으로 작업이 생성되는경우 저장소에 작업을 순차적으로 저장함으로써 작업간 충돌을 방지
 
```
